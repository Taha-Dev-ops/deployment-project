name: ğŸš€ Fully Automated CI/CD Deployment

on:
  push:
    branches: [main]

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v3

      - name: ğŸ” Security Scan
        run: |
          echo "ğŸ”’ Scanning code for vulnerabilities..."
          echo "ğŸ“ Files found:"
          find . -name "*.html" -o -name "*.js" -o -name "*.yml" | head -10
          
          # Security checks
          if find . -name "*.html" -exec grep -l "TODO\|FIXME" {} \; | grep -q .; then
            echo "âŒ TODO/FIXME comments found - Failing build"
            exit 1
          fi
          echo "âœ… All security checks passed"

  automated-deploy:
    runs-on: ubuntu-latest
    needs: security-scan
    if: success()
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v3

      - name: ğŸš€ Deploy to Production Server
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "=== ğŸš€ STARTING AUTOMATED DEPLOYMENT ==="
            cd /var/deployment-project
            echo "1. Pulling latest code..."
            git pull origin main
            echo "2. Restarting web server..."
            sudo systemctl restart nginx
            echo "3. Checking deployment status..."
            curl -s http://localhost | head -5
            echo "=== âœ… DEPLOYMENT COMPLETED SUCCESSFULLY ==="
            echo "ğŸŒ Live Website: http://${{ secrets.SERVER_HOST }}"
