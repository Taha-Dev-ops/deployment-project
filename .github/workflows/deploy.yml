name: ğŸš€ Deploy with Backup

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v3
      
    - name: ğŸ”’ SSH Deploy with Backup
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          echo "ğŸš€ Starting deployment..."
          
          # Step 1: Backup existing deployment
          cd /root/deployment-project
          ./scripts/backup.sh
          
          # Step 2: Deploy new code
          echo "ğŸ“¤ Deploying new version..."
          sudo cp -r app/* /var/www/html/
          sudo chown -R www-data:www-data /var/www/html/
          
          # Step 3: Verify deployment
          echo "âœ… Verifying deployment..."
          if curl -f http://localhost > /dev/null 2>&1; then
            echo "ğŸ‰ Deployment successful!"
          else
            echo "âŒ Deployment failed! Restoring backup..."
            ./scripts/restore.sh
            echo "ğŸ”„ Backup restored due to deployment failure"
            exit 1
          fi
          
          echo "ğŸ“Š Deployment Report:"
          echo "   Version: 1.0.0"
          echo "   Status: SUCCESS"
          echo "   Backup: Created"
          echo "   Time: $(date)"
